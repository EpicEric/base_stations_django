{% load leaflet_tags %}
<html>
  <head>
    <script type="module">export {Spinner};</script>
    {% leaflet_js %}
    {% leaflet_css %}
    <style>
      .leaflet-container {
        height: 100%;
      }
    </style>
    <script type="text/javascript">
      // Estimated location with GeoIP2
      var baseLocation = {{ location | safe }};

      window.addEventListener("map:init", function(event) {
        var map = event.detail.map;
        map.setMaxZoom(19);

        // Add tiling layer to fetch clusters when viewing a new tile
        var addTileLayer = function() {
          map.fetchID = 0;
          var tileLayer = L.gridLayer();
          tileLayer.on('tileload', function(e) {
              var tile = e.coords;
              // Use api endpoint to fetch data
              var baseURL = "{% url 'api:cluster-list' %}?zoom_size=" + tile.z + "&x_tile=" + tile.x + "&y_tile=" + tile.y;
              var fetchID = map.fetchID;
              fetchBaseStation(baseURL, fetchID);
          });
          map.addLayer(tileLayer);
        }

        // Function to fetch data from API
        var fetchBaseStation = function(url, id) {
          fetch(url).then(function(resp) {
            // Convert to GeoJSON
            return resp.json();
          }).then(function(data) {
            // Iterate over every feature and add to map
            layer = L.geoJson(data, {
              onEachFeature: function onEachFeature(feature, marker) {
                var props = feature.properties;
                if (props.count > 1) {
                  marker.bindTooltip(`${props.count}`);
                } else {
                  marker.bindTooltip(`${props.cgi}`);
                }
            }});
            layer.baseStation = true;
            // After changing zoom, do not add old markers to screen
            if (map.fetchID == id) {
              map.addLayer(layer);
            } else {
              console.log("bad id (" + map.fetchID + " != " + id + ")");
            }
            map.spin(false);
          });
        }

        // After zooming, clear markers
        map.on('zoomstart', function(e) {
          map.fetchID = (map.fetchID % 9007199254740991) + 1;
          map.eachLayer(function(layer) {
            if (layer.baseStation) {
              map.removeLayer(layer);
            }
          });
          map.spin(true);
          // Use API endpoint to fetch data
          var baseURL = "{% url 'api:base-station-list' %}?in_bbox=" + map.getBounds().toBBoxString();
        });

        // Attempt to get location with Geolocation API to update view
        map.locate().on("locationfound", function(e) {
          map.setView([e.latitude, e.longitude], 17);
          addTileLayer();
        }).on("locationerror", function(e) {
          map.setView(baseLocation, 17);
          addTileLayer();
        });
      });
    </script>
  </head>
  <body>
    {% leaflet_map 'main' %}
  </body>
</html>
